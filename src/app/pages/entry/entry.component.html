<div class="main-container">
    <app-navbar />
    <div class="content-wrapper">

        <div class="dropdown">
            <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown"
                aria-expanded="false">
                Summary
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li><button class="dropdown-item" (click)="showSection('daily')">Daily Entries</button></li>
                <li><button class="dropdown-item" (click)="showSection('monthly')">Monthly Summary</button></li>
                <li><button class="dropdown-item" (click)="showSection('overall')">Overall Summary</button></li>
            </ul>
        </div>

        <!-- Daily Section -->
        <div class="daily-main" *ngIf="activeSection === 'daily'">
            <div class="head-container">
                <div>
                    <h1>Daily Entries</h1>
                    <p>Entries on {{ model.day }}/{{ model.month }}/{{ model.year }}</p>
                </div>
            </div>
            <form class="row row-cols-sm-auto">
                <div class="col-12">
                    <div class="input-group">
                        <input class="form-control text-white" placeholder="yyyy-mm-dd" name="dp" [(ngModel)]="model"
                            ngbDatepicker #d="ngbDatepicker" (ngModelChange)="onDateChange()" />
                        <button class="btn btn-outline-secondary text-white" (click)="d.toggle()" type="button">
                            <i class="bi bi-calendar3"></i>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Loading state -->
            <div *ngIf="isLoadingDaily" class="text-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading daily entries...</p>
            </div>

            <!-- Error state -->
            <div *ngIf="dailyError && !isLoadingDaily" class="alert alert-danger" role="alert">
                {{ dailyError }}
                <button class="btn btn-sm btn-outline-danger ms-2" (click)="retryLoadDaily()">Retry</button>
            </div>

            <!-- Data display -->
            <div class="card" *ngIf="dailyEntries && !isLoadingDaily && !dailyError">
                <div class="card-body">
                    <p class="card-title">Total Cash: ₹{{ dailyEntries.totalCash | number:'1.2-2' }}</p>
                    <p class="card-title">Total Wholesale: ₹{{ dailyEntries.totalWholesale | number:'1.2-2' }}</p>
                    <p class="">Total Entries: {{ dailyEntries.totalEntries }}</p>
                </div>
            </div>
            <!-- Daily Entry Cards -->
            <div *ngIf="dailyEntries && dailyEntries.entries && !isLoadingDaily && !dailyError">
                <div class="card mb-2" *ngFor="let entry of dailyEntries.entries">
                    <div class="card-body">
                        <!-- Normal view -->
                        <div *ngIf="!isEditing || editingEntry._id !== entry._id">
                            <p class="card-title">{{ entry.type }}</p>
                            <p *ngIf="entry.type === 'Wholesale'" class="card-text">Party: {{ entry.partyName }}</p>
                            <p class="card-text">Amount: ₹{{ entry.amount | number:'1.2-2' }}</p>
                            <button class="btn btn-outline-primary me-2" (click)="editEntry(entry)">
                                Edit
                            </button>
                            <button class="btn btn-outline-danger" (click)="deleteEntry(entry._id)">
                                Delete
                            </button>
                        </div>

                        <!-- Edit view -->
                        <div *ngIf="isEditing && editingEntry._id === entry._id">
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" [(ngModel)]="editingEntry.amount">
                            </div>

                            <div class="mb-3" *ngIf="editingEntry.type === 'Wholesale'">
                                <label class="form-label">Party Name</label>
                                <input type="text" class="form-control" [(ngModel)]="editingEntry.partyName">
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="editType" id="editCash"
                                        value="Cash" [(ngModel)]="editingEntry.type">
                                    <label class="form-check-label" for="editCash">Cash</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="editType" id="editWholesale"
                                        value="Wholesale" [(ngModel)]="editingEntry.type">
                                    <label class="form-check-label" for="editWholesale">Wholesale</label>
                                </div>
                            </div>

                            <button class="btn btn-success me-2" (click)="updateEntry()">
                                Save
                            </button>
                            <button class="btn btn-secondary" (click)="cancelEdit()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Monthly Section -->
        <div class="monthly-main" *ngIf="activeSection === 'monthly'">
            <div>
                <h1>Monthly Entries</h1>
                <p>Entries in {{ selectedMonth }}/{{ model.year }}</p>
            </div>
            <form class="row row-cols-sm-auto">
                <div class="col-12">
                    <div class="col-md-4">
                        <select id="inputState" class="form-select" [value]="selectedMonth"
                            (change)="onMonthChange($event)">
                            <option *ngFor="let num of numbers" value="{{num}}">{{num}}</option>
                        </select>
                        <input class="form-control mt-2" name="dp" [(ngModel)]="model.year" type="number"
                            (ngModelChange)="onYearChange()" />
                    </div>
                </div>
            </form>


            <!-- Loading state -->
            <div *ngIf="isLoadingMonthly" class="text-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading monthly entries...</p>
            </div>

            <!-- Error state -->
            <div *ngIf="monthlyError && !isLoadingMonthly" class="alert alert-danger" role="alert">
                {{ monthlyError }}
                <button class="btn btn-sm btn-outline-danger ms-2" (click)="retryLoadMonthly()">Retry</button>
            </div>

            <!-- Data display -->
            <div class="card" *ngIf="monthlyEntries && !isLoadingMonthly && !monthlyError">
                <div class="card-body">
                    <p class="card-title">Total Cash: ₹{{ monthlyEntries.totalCash | number:'1.2-2' }}</p>
                    <p class="card-title">Total Wholesale: ₹{{ monthlyEntries.totalWholesale | number:'1.2-2' }}</p>
                    <p class="text-muted">Total Entries: {{ monthlyEntries.totalEntries }}</p>
                </div>
            </div>
            <!-- Monthly Entry Cards -->
            <div *ngIf="monthlyEntries && monthlyEntries.entries && !isLoadingMonthly && !monthlyError">
                <div class="card mb-2" *ngFor="let entry of getDateWiseSummary(monthlyEntries.entries)">
                    <div class="card-body">
                        <p class="card-title">{{ entry.date }}</p>
                        <p class="card-text">Total Cash: ₹{{ entry.totalCash | number:'1.2-2' }}</p>
                        <p class="card-text">Total Wholesale: ₹{{ entry.totalWholesale | number:'1.2-2' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Section -->
        <div class="overall-main" *ngIf="activeSection === 'overall'">
            <div>
                <h1>Overall Entries</h1>
                <p>All-time summary</p>
            </div>

            <!-- Loading state -->
            <div *ngIf="isLoadingOverall" class="text-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading overall entries...</p>
            </div>

            <!-- Error state -->
            <div *ngIf="overallError && !isLoadingOverall" class="alert alert-danger" role="alert">
                {{ overallError }}
                <button class="btn btn-sm btn-outline-danger ms-2" (click)="retryLoadOverall()">Retry</button>
            </div>

            <!-- Data display -->
            <div class="card" *ngIf="overallEntries && !isLoadingOverall && !overallError">
                <div class="card-body">
                    <h5 class="card-title">Summary</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Total Cash:</strong> ₹{{ overallEntries.totalCash | number:'1.2-2'
                                }}</p>
                            <p class="mb-2"><strong>Total Wholesale:</strong> ₹{{ overallEntries.totalWholesale |
                                number:'1.2-2' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>Grand Total:</strong> ₹{{ (overallEntries.totalCash +
                                overallEntries.totalWholesale) | number:'1.2-2' }}</p>
                            <p class="mb-2"><strong>Total Entries:</strong> {{ overallEntries.totalEntries }}</p>
                        </div>
                    </div>
                    <div *ngIf="overallEntries.dateRange" class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-calendar-range"></i>
                            Date Range: {{ overallEntries.dateRange.from }} to {{ overallEntries.dateRange.to }}
                        </small>
                    </div>
                </div>
            </div>
            <!-- Overall Entry Cards -->
            <div *ngIf="overallEntries && overallEntries.entries && !isLoadingOverall && !overallError">
                <div class="card mb-2" *ngFor="let entry of getMonthWiseSummary(overallEntries.entries)">
                    <div class="card-body">
                        <p class="card-title">{{ entry.month }}/{{ entry.year }}</p>
                        <p class="card-text">Total Cash: ₹{{ entry.totalCash | number:'1.2-2' }}</p>
                        <p class="card-text">Total Wholesale: ₹{{ entry.totalWholesale | number:'1.2-2' }}</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <app-footer />
</div>